<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>Auto Blur (Face + Body) via Screen Share</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>

<style>
  body { margin:0; background:#000; color:#fff; font-family:system-ui; }
  #controls { position:fixed; top:10px; left:10px; z-index:10; }
  button { padding:10px 14px; font-size:16px; }
  video, canvas { position:absolute; top:0; left:0; }
</style>
</head>
<body>

<div id="controls">
  <button id="start">ابدأ (مشاركة الشاشة)</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const startBtn = document.getElementById('start');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let bodyNet, faceNet;

async function initModels() {
  bodyNet = await bodyPix.load();
  faceNet = await faceDetection.createDetector(
    faceDetection.SupportedModels.MediaPipeFaceDetector,
    { runtime: 'tfjs' }
  );
}

async function startShare() {
  const stream = await navigator.mediaDevices.getDisplayMedia({
    video: { frameRate: 30 },
    audio: false
  });
  video.srcObject = stream;

  await new Promise(r => video.onloadedmetadata = r);
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  if (!bodyNet || !faceNet) await initModels();
  loop();
}

async function loop() {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // تشويش الجسم
  const person = await bodyNet.segmentPerson(video);
  bodyPix.drawBokehEffect(
    canvas,
    video,
    person,
    25, // قوة تشويش الجسم
    7,
    false
  );

  // تشويش الوجه
  const faces = await faceNet.estimateFaces(video);
  faces.forEach(face => {
    const b = face.box;
    ctx.filter = "blur(30px)";
    ctx.drawImage(
      video,
      b.xMin, b.yMin, b.width, b.height,
      b.xMin, b.yMin, b.width, b.height
    );
    ctx.filter = "none";
  });

  requestAnimationFrame(loop);
}

startBtn.onclick = startShare;
</script>
</body>
</html>
