(async () => {
  if (!document.querySelector("video")) return;

  const EXCLUDED_HOSTS = ["tiktok.com"];
  if (EXCLUDED_HOSTS.some(h => location.hostname.includes(h))) return;

  const load = src => new Promise(r => {
    const s = document.createElement("script");
    s.src = src; s.onload = r;
    document.head.appendChild(s);
  });

  await load("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0");
  await load("https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix");
  await load("https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js");

  await faceapi.nets.tinyFaceDetector.loadFromUri(
    "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/"
  );
  await faceapi.nets.ageGenderNet.loadFromUri(
    "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/"
  );

  const video = document.querySelector("video");
  const wrap = video.parentElement;
  wrap.style.position = "relative";

  const canvas = document.createElement("canvas");
  Object.assign(canvas.style, {
    position: "absolute", inset: 0, pointerEvents: "none"
  });
  wrap.appendChild(canvas);
  const ctx = canvas.getContext("2d");

  const ui = document.createElement("div");
  ui.innerHTML = `
    <style>
      .hm-ui{position:absolute;top:8px;right:8px;z-index:9999;
      background:#111;color:#fff;padding:8px;border-radius:10px;font:12px system-ui}
      .hm-ui button,.hm-ui select{margin:4px}
    </style>
    <div class="hm-ui">
      <button id="hmToggle">ON</button>
      <select id="hmLevel">
        <option value="strict">Strict</option>
        <option value="smart" selected>Smart</option>
        <option value="relaxed">Relaxed</option>
      </select>
    </div>`;
  wrap.appendChild(ui);

  let enabled = localStorage.getItem("hm_enabled") !== "0";
  let level = localStorage.getItem("hm_level") || "smart";
  document.getElementById("hmToggle").textContent = enabled ? "ON" : "OFF";
  document.getElementById("hmLevel").value = level;

  document.getElementById("hmToggle").onclick = () => {
    enabled = !enabled;
    localStorage.setItem("hm_enabled", enabled ? "1" : "0");
    document.getElementById("hmToggle").textContent = enabled ? "ON" : "OFF";
    ctx.clearRect(0,0,canvas.width,canvas.height);
  };
  document.getElementById("hmLevel").onchange = e => {
    level = e.target.value;
    localStorage.setItem("hm_level", level);
  };

  const bodyNet = await bodyPix.load();
  let frame = 0;

  function resize() {
    canvas.width = video.videoWidth || wrap.clientWidth;
    canvas.height = video.videoHeight || wrap.clientHeight;
  }
  video.addEventListener("loadeddata", resize);
  resize();

  async function loop() {
    requestAnimationFrame(loop);
    if (!enabled) return;

    frame++;
    if (frame % 3 !== 0) return; // تحسين الأداء

    resize();
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dets = await faceapi
      .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
      .withAgeAndGender();

    for (const d of dets) {
      const g = d.gender;
      const p = d.genderProbability;

      let blur = false;
      if (level === "strict") blur = (g === "female") || (p < 0.85);
      if (level === "smart")  blur = (g === "female") || (g === "male" && p < 0.80);
      if (level === "relaxed")blur = (g === "female" && p > 0.70);

      if (blur) {
        const person = await bodyNet.segmentPerson(video);
        bodyPix.drawBokehEffect(canvas, video, person, 35, 7, false);

        const b = d.detection.box;
        ctx.filter = "blur(40px)";
        ctx.drawImage(video, b.x, b.y, b.width, b.height, b.x, b.y, b.width, b.height);
        ctx.filter = "none";
      }
    }
  }
  loop();
})();
